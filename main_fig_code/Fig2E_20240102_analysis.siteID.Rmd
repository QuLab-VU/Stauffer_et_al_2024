---
title: "P2RX inhibitor CRC Time series -- 20240102"
output: html_notebook
---

# Data analysis for P2RX inhibitor cotreatment CRC screen on cells treated with BRAFi for 3 days at the point of fixation.

```{r Setup}
library(diprate)
library(ggplot2)
library(viridis)
library(tidyr)
library(dplyr)
library(drc)
```

## Load data
```{r}
db_path <- "https://www.dropbox.com/scl/fi/nbj4s1ocdy5w5yzdflpdo/20240102_singlecell_all.siteID.csv?rlkey=njniz3f95d59m9azpvmgqrj93&dl=1"

d <- read.csv(db_path)
```



# QC
Removing cells with total area > 4500 and < 50 $pixels^2$  
Removing cells with integrated intensity > 5e6  
It was found that setting minimum area to above 200 pixels^2 predominantly filtered out data from the Ca2+ free control group. Because of this bias in filtering, minimum area was set to > 100 pixels. 

### Filtering (QC)
```{r}
o_nrow <- nrow(d)
d <- d[d$total.area < 4500 & d$total.area > 50 & d$w2.stain.integr.intens <5e6,]
message(cat("Current nrow = ",nrow(d),"\nOriginal nrow = ",o_nrow))
message(cat("QC removed",signif(100-(nrow(d)/o_nrow*100),2),"% of cells"))
```


### Annotation
* Columns 18 and 19: untreated control; all others: 8 ÂµM PLX-4720 for 3 days 
* When `drug1== "veh"`, that is when there is serum free media added without inhibitor present at each time point; this is the baseline ppERK staining for each drug at the respective time points.
* When `drug1== "persistent"`, there was no media added until immediately after PFA was added to all wells
* When `drug1== "control"`, that is the drug naive control (column 18) with serum free media added
* When `drug1== ""` & `drug2== ""`, that is the antibody control


```{r}
d$drug1[d$drug1== ""] <- "abctrl"
ab_ctrl_wells <- unique(d[d$drug1=="abctrl",]$well)
untx_ctrl_wells <- unique(d[d$drug1=="control",]$well)
ctrl_wells <- c(ab_ctrl_wells,untx_ctrl_wells)

d[is.na(d$drug1.conc),"drug1.conc"] <- -1


d$barcode <- "97595PS3"
d$barcode[d$plate.id== 142707] <- "97596PS4"

tx <- tibble(d[!d$well %in% ctrl_wells, ])
tx <- tx[order(tx$inh.tx.time),]

rownames(tx) <- NULL

ctrls <- d[d$well %in% ctrl_wells, ]

tx$drug1.conc <- signif(tx$drug1.conc, digits= 2)
#vehctrls_wells refers to 0 M of drug condition added at each time point and time point == 0
txctrls <- tx[tx$drug1== "veh",]
```


### sites to remove based upon visual QC (i.e. removing bright debris containing sites)
Wells I12 amd J12 have large particulates that throw off quantification; exclude sites I12.1, I12.3, and J12.2
```{r}
debris4 <- data.frame(well.site= c("I12.1", "I12.3", "J12.2"))
```

```{r}
tx$well.site <- paste0(tx$well, ".", tx$site.id)
tx4 <- tx[tx$barcode== "97596PS4", ]
tx4 <- tx4[!tx4$well.site %in% debris4$well.site, ]


tx3 <- tx[tx$barcode== "97595PS3", ]

tx <- rbind(tx3, tx4)
```




```{r}
ppdf <- tx %>%
    group_by(BRAFi.tx.time, well, drug1, drug1.conc, inh.tx.time, positive.w2) %>%
    summarise(num= n()) 

ppdf$positive.w2 <- rep(c("negative","positive"), nrow(ppdf)/2)

pct.pos <- ppdf %>%
    spread(positive.w2, num) %>%
    mutate(total= negative+positive) %>%
    summarise(propos= positive/total) %>%
    ungroup()

pos.drugs <- c("aacba", "a740003",  "azd9056", "isoPPADS", "bx430","gefapixant","veh")

pct.pos <- pct.pos[(pct.pos$drug1 %in% pos.drugs & pct.pos$inh.tx.time %in%  c(0, 1)), ]
```


## DRT addition: normalizing to vehicle mean
Assume a slightly lower concentration than the lowest concentration tested had no effect (this enforces a conservative estimate of EC50, otherwise the model may not converge).

```{r}
normdat <- as.data.frame(pct.pos)
normdat$pct_veh <- normdat$propos/mean(normdat[normdat$drug1=="veh","propos"])
fakedata <- normdat[!duplicated(normdat$drug1) & normdat$drug1!="veh",]
fakedata$well <- c("A01","B01","C01","D01","E01","F01")
fakedata$drug1.conc <- 1e-9
fakedata$propos <- NA
fakedata$pct_veh <- 1
normdat <- rbind(normdat,fakedata)

normdat <- normdat[order(normdat$drug1,normdat$drug1.conc),]
```

### fit drug responses data with LL.3u()
```{r warning=FALSE}
normdat.drm <- drm(pct_veh ~ drug1.conc,
                        data=normdat[!normdat$drug1 %in% c("veh","gefapixant","bx430"), ],
                        fct = LL.3u(),
                        curveid = drug1)

```

```{r}
fitLL3 <- function(dat, drug, ...) {
    dtp <- dat[dat$drug1 %in% c(drug, "veh"),]    
    drm(pct_veh ~ drug1.conc, data=dtp, fct = LL.3u(), ...)
}

```

### LL3 model fits of BX430 and gefapixant
```{r}
bx430.drm <- fitLL3(normdat, "bx430")
gef.drm <- fitLL3(normdat, "gefapixant")
```

```{r}
bx430.coef <- as.list(coef(bx430.drm))
bx430.coef <- append(append(bx430.coef[1:2], list('d:(Intercept)'=1)), bx430.coef[3])

gef.coef <- as.list(coef(gef.drm))
gef.coef <- append(append(gef.coef[1:2], list('d:(Intercept)'=1)), gef.coef[3])

x <- 10^seq(-9,-6,.1) # drug1.conc values for plotting
```

```{r fig.height=4, fig.width=4}
mycolors <- viridis::magma(7, direction=-1)[-1]

save_fn <- "~/Desktop/P2Xi_ppERK_dose-response.pdf"
# pdf(save_fn, width=4, height=4)

plot(normdat.drm, xlab="[Drug], M", ylab="ppERK, fraction of control", type='none', 
     legend=FALSE, xaxt="n",
     legendPos=c(2e-8,0.73), cex.legend=0.75,
     ylim=c(0.5,1.0), 
     col=mycolors[1:4], lty=1,
     lwd=2)
# curve(do.call(myll4, args = append(list(x), bx430.coef)), from = 1e-9, to = 1.5e-06, add = TRUE)

lines(x,myll4(x,bx430.coef[[1]],bx430.coef[[2]],1,bx430.coef[[4]]), col=mycolors[5], lwd=2, lty=2)
lines(x,myll4(x,gef.coef[[1]],gef.coef[[2]],1,gef.coef[[4]]), col=mycolors[6], lwd=2, lty=3)

legend("bottomleft", inset=c(0,0), legend=unique(normdat.drm$origData$drug1)[1:3], lty=1, lwd=2,
       col=mycolors[c(3,4,2)], cex=0.75, xpd=TRUE, bty="n")
legend("bottomleft", inset=c(0.35,0), legend=c(unique(normdat.drm$origData$drug1)[4],"bx430","gefapixant"), lty=1:3, lwd=2,
       col=mycolors[c(1,5,6)], cex=0.75, xpd=TRUE, bty="n")

```


